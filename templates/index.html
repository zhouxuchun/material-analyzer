<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ææ–™åŠ›å­¦æ€§èƒ½åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .panel h2 {
            color: #3498db;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 1.1em;
        }
        
        select, input[type="file"], button {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        select:focus, input[type="file"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2c3e50);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 1px;
            margin-top: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(52, 152, 219, 0.3);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button.secondary {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            margin-top: 15px;
        }
        
        button.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            text-align: center;
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .results-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .result-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .result-item strong {
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .result-item span {
            color: #e74c3c;
            font-weight: 600;
            font-size: 1.2em;
            text-align: right;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .material-badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(45deg, #3498db, #2c3e50);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ§ª ææ–™åŠ›å­¦æ€§èƒ½åˆ†æç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ åº”åŠ›-åº”å˜æ•°æ®æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å¼¹æ€§æ¨¡é‡ã€å±ˆæœå¼ºåº¦ã€æŠ—æ‹‰å¼ºåº¦ç­‰å…³é”®åŠ›å­¦æ€§èƒ½å‚æ•°</p>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div>
                <span id="dataStatus">ğŸ“Š æœªåŠ è½½æ•°æ®</span>
                <span id="materialBadge" class="material-badge" style="display: none;">ææ–™ç±»å‹</span>
            </div>
            <div>
                <span id="dataPoints">æ•°æ®ç‚¹: 0</span>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šæ•°æ®è¾“å…¥é¢æ¿ -->
            <div class="panel">
                <h2>ğŸ“ æ•°æ®è¾“å…¥</h2>
                
                <div class="form-group">
                    <label>é€‰æ‹©ææ–™ç±»å‹</label>
                    <select id="materialType">
                        <option value="é’¢">é’¢</option>
                        <option value="é“">é“</option>
                        <option value="é“œ">é“œ</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ä¸Šä¼ CSVæ•°æ®æ–‡ä»¶</label>
                    <input type="file" id="csvFile" accept=".csv,.txt,.dat">
                    <small style="color: #7f8c8d; display: block; margin-top: 8px;">
                        æ”¯æŒæ ¼å¼ï¼šCSVã€TXTã€DATã€‚æ–‡ä»¶åº”åŒ…å«åº”å˜å’Œåº”åŠ›ä¸¤åˆ—æ•°æ®ã€‚
                    </small>
                </div>
                
                <button onclick="uploadCSV()">ğŸ“¤ ä¸Šä¼ å¹¶è§£ææ•°æ®</button>
                <button class="secondary" onclick="loadExampleData()">ğŸ“Š åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                <button class="danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
            </div>
            
            <!-- å³ä¾§ï¼šåˆ†ææ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <h2>âš™ï¸ åˆ†ææ§åˆ¶</h2>
                
                <div class="alert alert-info">
                    <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
                    1. é¦–å…ˆä¸Šä¼ æ•°æ®æˆ–åŠ è½½ç¤ºä¾‹<br>
                    2. ç‚¹å‡»"åˆ†æææ–™æ€§èƒ½"è¿›è¡Œè®¡ç®—<br>
                    3. æŸ¥çœ‹åˆ†æç»“æœå¹¶ç”ŸæˆæŠ¥å‘Š
                </div>
                
                <div class="btn-group">
                    <button onclick="analyzeMaterial()">ğŸ”¬ åˆ†æææ–™æ€§èƒ½</button>
                    <button onclick="generateReport()">ğŸ“„ ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
                </div>
                
                <button onclick="downloadReport()">ğŸ’¾ ä¸‹è½½æŠ¥å‘Šæ–‡ä»¶</button>
            </div>
        </div>
        
        <!-- å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="chart-container" id="chartContainer" style="display: none;">
            <h2>ğŸ“ˆ åº”åŠ›-åº”å˜æ›²çº¿</h2>
            <div id="chartImage"></div>
        </div>
        
        <!-- åˆ†æç»“æœåŒºåŸŸ -->
        <div class="results-panel" id="resultsPanel" style="display: none;">
            <h2>ğŸ“Š ææ–™æ€§èƒ½åˆ†æç»“æœ</h2>
            <div id="resultsContent"></div>
        </div>
        
        <!-- æŠ¥å‘ŠåŒºåŸŸ -->
        <div class="results-panel" id="reportPanel" style="display: none;">
            <h2>ğŸ“‹ åˆ†ææŠ¥å‘Š</h2>
            <pre id="reportContent" style="background: #f8f9fa; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: monospace;"></pre>
        </div>
        
        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div id="messageContainer"></div>
    </div>
    
    <div class="footer">
        <p>ææ–™åŠ›å­¦æ€§èƒ½åˆ†æç³»ç»Ÿ &copy; 2024 | åŸºäºFlaskæ„å»º</p>
    </div>

    <script>
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            container.appendChild(alert);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar(hasData, points = 0, material = '') {
            const statusBar = document.getElementById('statusBar');
            const dataStatus = document.getElementById('dataStatus');
            const materialBadge = document.getElementById('materialBadge');
            const dataPoints = document.getElementById('dataPoints');
            
            if (hasData) {
                dataStatus.innerHTML = `ğŸ“Š å·²åŠ è½½æ•°æ® (${points} ä¸ªç‚¹)`;
                materialBadge.textContent = material;
                materialBadge.style.display = 'inline-block';
                dataPoints.textContent = `æ•°æ®ç‚¹: ${points}`;
            } else {
                dataStatus.textContent = 'ğŸ“Š æœªåŠ è½½æ•°æ®';
                materialBadge.style.display = 'none';
                dataPoints.textContent = 'æ•°æ®ç‚¹: 0';
            }
        }
        
        // ä¸Šä¼ CSVæ–‡ä»¶
        async function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const materialType = document.getElementById('materialType').value;
            
            if (!fileInput.files[0]) {
                showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('material_type', materialType);
            
            showLoading(true);
            
            try {
                const response = await fetch('/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // æ˜¾ç¤ºå›¾è¡¨
                    document.getElementById('chartContainer').style.display = 'block';
                    document.getElementById('chartImage').innerHTML = `<img src="data:image/png;base64,${result.chart}" alt="åº”åŠ›-åº”å˜æ›²çº¿">`;
                    
                    // æ›´æ–°çŠ¶æ€æ 
                    updateStatusBar(true, result.data_points, materialType);
                    
                    // éšè—ç»“æœé¢æ¿ï¼ˆå› ä¸ºæ–°æ•°æ®éœ€è¦é‡æ–°åˆ†æï¼‰
                    document.getElementById('resultsPanel').style.display = 'none';
                    document.getElementById('reportPanel').style.display = 'none';
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // åŠ è½½ç¤ºä¾‹æ•°æ®
        async function loadExampleData() {
            const materialType = document.getElementById('materialType').value;
            
            showLoading(true);
            
            try {
                const response = await fetch('/load_example', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ material_type: materialType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // æ˜¾ç¤ºå›¾è¡¨
                    document.getElementById('chartContainer').style.display = 'block';
                    document.getElementById('chartImage').innerHTML = `<img src="data:image/png;base64,${result.chart}" alt="åº”åŠ›-åº”å˜æ›²çº¿">`;
                    
                    // æ›´æ–°çŠ¶æ€æ 
                    updateStatusBar(true, result.data_points, materialType);
                    
                    // éšè—ç»“æœé¢æ¿
                    document.getElementById('resultsPanel').style.display = 'none';
                    document.getElementById('reportPanel').style.display = 'none';
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // åˆ†æææ–™æ€§èƒ½
        async function analyzeMaterial() {
            showLoading(true);
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // æ›´æ–°å›¾è¡¨
                    document.getElementById('chartContainer').style.display = 'block';
                    document.getElementById('chartImage').innerHTML = `<img src="data:image/png;base64,${result.chart}" alt="åº”åŠ›-åº”å˜æ›²çº¿">`;
                    
                    // æ˜¾ç¤ºç»“æœ
                    const resultsContent = document.getElementById('resultsContent');
                    resultsContent.innerHTML = '';
                    
                    for (const [key, value] of Object.entries(result.results)) {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <strong>${key}</strong>
                            <span>${value.value.toFixed(2)} ${value.unit}</span>
                        `;
                        resultsContent.appendChild(div);
                    }
                    
                    document.getElementById('resultsPanel').style.display = 'block';
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('åˆ†æå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ç”Ÿæˆåˆ†ææŠ¥å‘Š
        async function generateReport() {
            showLoading(true);
            
            try {
                const response = await fetch('/generate_report', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // æ˜¾ç¤ºæŠ¥å‘Š
                    document.getElementById('reportContent').textContent = result.report;
                    document.getElementById('reportPanel').style.display = 'block';
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ä¸‹è½½æŠ¥å‘Š
        async function downloadReport() {
            window.open('/download_report', '_blank');
        }
        
        // æ¸…é™¤æ•°æ®
        async function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;
            
            showLoading(true);
            
            try {
                const response = await fetch('/clear_data', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // é‡ç½®ç•Œé¢
                    document.getElementById('chartContainer').style.display = 'none';
                    document.getElementById('resultsPanel').style.display = 'none';
                    document.getElementById('reportPanel').style.display = 'none';
                    document.getElementById('csvFile').value = '';
                    
                    // æ›´æ–°çŠ¶æ€æ 
                    updateStatusBar(false);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æ¸…é™¤å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®çŠ¶æ€
        async function loadDataStatus() {
            try {
                const response = await fetch('/data_summary');
                const result = await response.json();
                
                if (result.success && result.has_data) {
                    updateStatusBar(true, result.data_points, result.material_type);
                    
                    // å¦‚æœæœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
                    document.getElementById('chartContainer').style.display = 'block';
                    document.getElementById('chartImage').innerHTML = '<p>ğŸ“Š æ•°æ®å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"åˆ†æææ–™æ€§èƒ½"æŸ¥çœ‹å›¾è¡¨</p>';
                    
                    // è®¾ç½®ææ–™ç±»å‹é€‰æ‹©
                    document.getElementById('materialType').value = result.material_type;
                }
            } catch (error) {
                console.log('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadDataStatus();
        });
    </script>
</body>
</html>
